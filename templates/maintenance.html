{% extends "base.html" %}

{% block title %}Maintenance{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mt-5 mb-4">Maintenance</h1>

    <!-- Sync Controls -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-1">Area Lint Status</h5>
                    <p class="text-muted mb-0" id="lastSyncText">Last sync: Never</p>
                </div>
                <button id="syncBtn" class="btn btn-primary">
                    <span id="syncBtnText">Sync Areas</span>
                    <span id="syncSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4" id="filtersCard" style="display: none;">
        <div class="card-body">
            <div class="row">
                <div class="col-md-2">
                    <label for="typeFilter" class="form-label">Area Type</label>
                    <select id="typeFilter" class="form-select">
                        <option value="">All Types</option>
                        <option value="community" selected>Community</option>
                        <option value="country">Country</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="continentFilter" class="form-label">Continent</label>
                    <select id="continentFilter" class="form-select">
                        <option value="">All Continents</option>
                        <option value="africa">Africa</option>
                        <option value="asia">Asia</option>
                        <option value="europe">Europe</option>
                        <option value="north-america">North America</option>
                        <option value="oceania">Oceania</option>
                        <option value="south-america">South America</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="countryFilter" class="form-label">Country</label>
                    <select id="countryFilter" class="form-select">
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="organizationFilter" class="form-label">Organization</label>
                    <select id="organizationFilter" class="form-select">
                        <option value="">All Orgs</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-2">
                    <label for="ruleFilter" class="form-label">Filter by Rule</label>
                    <select id="ruleFilter" class="form-select">
                        <option value="">All Rules</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="severityFilter" class="form-label">Filter by Severity</label>
                    <select id="severityFilter" class="form-select">
                        <option value="">All Severities</option>
                        <option value="error">Errors</option>
                        <option value="warning">Warnings</option>
                        <option value="info">Info</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" id="includeDeleted">
                        <label class="form-check-label" for="includeDeleted">Include Deleted</label>
                    </div>
                </div>
            </div>
            
            <!-- Tag Search -->
            <div class="row mt-3">
                <div class="col-12">
                    <label class="form-label">Tag Search</label>
                    <div id="tagFiltersContainer">
                        <!-- Tag filter rows will be added here -->
                    </div>
                    <button type="button" id="addTagFilterBtn" class="btn btn-sm btn-outline-secondary mt-2">
                        + Add Tag Filter
                    </button>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12 d-flex justify-content-end">
                    <button id="clearFiltersBtn" class="btn btn-outline-secondary me-2">Clear All</button>
                    <button id="applyFiltersBtn" class="btn btn-primary">Apply Filters</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row mb-4" id="summaryStats" style="display: none;">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="mb-0" id="statTotalAreas">0</h3>
                    <small class="text-muted">Total Areas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="mb-0" id="statAreasWithIssues">0</h3>
                    <small class="text-muted">Areas with Issues</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-danger">
                <div class="card-body">
                    <h3 class="mb-0 text-danger" id="statErrors">0</h3>
                    <small class="text-muted">Errors</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h3 class="mb-0 text-warning" id="statWarnings">0</h3>
                    <small class="text-muted">Warnings</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    <div class="card mb-5" id="resultsCard" style="display: none;">
        <div class="card-header">
            <h5 class="mb-0">Areas Requiring Attention</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Area</th>
                            <th>Type</th>
                            <th>Issues</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- Results will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer">
            <nav aria-label="Results pagination">
                <ul class="pagination justify-content-center mb-0" id="pagination">
                    <!-- Pagination will be populated here -->
                </ul>
            </nav>
        </div>
    </div>

    <!-- Empty State -->
    <div class="card" id="emptyState" style="display: none;">
        <div class="card-body text-center py-5">
            <h5 class="text-muted">No lint issues found</h5>
            <p class="text-muted mb-0">All areas are passing lint checks.</p>
        </div>
    </div>

    <!-- Initial State -->
    <div class="card" id="initialState">
        <div class="card-body text-center py-5">
            <h5 class="text-muted">No data synced yet</h5>
            <p class="text-muted mb-3">Click "Sync Areas" to fetch and lint all areas.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const syncBtn = document.getElementById('syncBtn');
    const syncBtnText = document.getElementById('syncBtnText');
    const syncSpinner = document.getElementById('syncSpinner');
    const lastSyncText = document.getElementById('lastSyncText');
    const summaryStats = document.getElementById('summaryStats');
    const filtersCard = document.getElementById('filtersCard');
    const resultsCard = document.getElementById('resultsCard');
    const resultsTableBody = document.getElementById('resultsTableBody');
    const emptyState = document.getElementById('emptyState');
    const initialState = document.getElementById('initialState');
    const typeFilter = document.getElementById('typeFilter');
    const continentFilter = document.getElementById('continentFilter');
    const countryFilter = document.getElementById('countryFilter');
    const organizationFilter = document.getElementById('organizationFilter');
    const ruleFilter = document.getElementById('ruleFilter');
    const severityFilter = document.getElementById('severityFilter');
    const includeDeleted = document.getElementById('includeDeleted');
    const applyFiltersBtn = document.getElementById('applyFiltersBtn');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    const addTagFilterBtn = document.getElementById('addTagFilterBtn');
    const tagFiltersContainer = document.getElementById('tagFiltersContainer');
    const pagination = document.getElementById('pagination');

    let availableTags = [];
    let availableCountries = [];
    let availableOrganizations = [];
    let allResults = [];  // Store all results for pagination
    let currentPage = 1;
    const pageSize = 25;

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Load initial state
    loadSummary();
    loadRules();
    loadTags();
    loadCountries();
    loadOrganizations();

    // Event listeners
    syncBtn.addEventListener('click', syncAreas);
    applyFiltersBtn.addEventListener('click', loadResults);
    clearFiltersBtn.addEventListener('click', clearAllFilters);
    addTagFilterBtn.addEventListener('click', addTagFilterRow);

    function getFilterParams() {
        let params = new URLSearchParams();
        if (typeFilter.value) params.append('type', typeFilter.value);
        if (continentFilter.value) params.append('tag.continent', continentFilter.value);
        if (countryFilter.value) params.append('country', countryFilter.value);
        if (organizationFilter.value) params.append('tag.organization', organizationFilter.value);
        if (ruleFilter.value) params.append('rule', ruleFilter.value);
        if (severityFilter.value) params.append('severity', severityFilter.value);
        if (includeDeleted.checked) params.append('include_deleted', 'true');
        
        // Add tag filters
        const tagRows = tagFiltersContainer.querySelectorAll('.tag-filter-row');
        tagRows.forEach(row => {
            const tagName = row.querySelector('.tag-name-select').value;
            const tagValue = row.querySelector('.tag-value-input').value;
            if (tagName) {
                params.append(`tag.${tagName}`, tagValue);
            }
        });
        
        return params.toString();
    }

    function clearAllFilters() {
        typeFilter.value = 'community';
        continentFilter.value = '';
        countryFilter.value = '';
        organizationFilter.value = '';
        ruleFilter.value = '';
        severityFilter.value = '';
        includeDeleted.checked = false;
        tagFiltersContainer.innerHTML = '';
        loadResults();
    }

    function addTagFilterRow() {
        const row = document.createElement('div');
        row.className = 'tag-filter-row d-flex gap-2 mb-2 align-items-center';
        
        const tagOptions = availableTags.map(tag => 
            `<option value="${escapeHtml(tag)}">${escapeHtml(tag)}</option>`
        ).join('');
        
        row.innerHTML = `
            <select class="form-select form-select-sm tag-name-select" style="width: 200px;">
                <option value="">Select tag...</option>
                ${tagOptions}
            </select>
            <input type="text" class="form-control form-control-sm tag-value-input" placeholder="Value (empty=any, *=wildcard)" style="width: 250px;">
            <button type="button" class="btn btn-sm btn-outline-danger remove-tag-filter">Remove</button>
        `;
        
        row.querySelector('.remove-tag-filter').addEventListener('click', () => row.remove());
        tagFiltersContainer.appendChild(row);
    }

    async function loadSummary() {
        try {
            const params = getFilterParams();
            const response = await fetch(`/api/lint/summary?${params}`);
            const data = await response.json();
            
            if (data.last_sync) {
                updateUI(data);
            }
        } catch (error) {
            console.error('Error loading summary:', error);
        }
    }

    async function loadRules() {
        try {
            const response = await fetch('/api/lint/rules');
            const data = await response.json();
            
            data.rules.forEach(rule => {
                const option = document.createElement('option');
                option.value = rule.id;
                option.textContent = rule.name;
                ruleFilter.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading rules:', error);
        }
    }

    async function loadTags() {
        try {
            const response = await fetch('/api/lint/tags');
            const data = await response.json();
            availableTags = data.tags || [];
        } catch (error) {
            console.error('Error loading tags:', error);
        }
    }

    async function loadCountries() {
        try {
            const response = await fetch('/api/lint/countries');
            const data = await response.json();
            availableCountries = data.countries || [];
            
            // Populate country dropdown
            countryFilter.innerHTML = '<option value="">All Countries</option>';
            availableCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.id;
                option.textContent = country.name;
                countryFilter.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading countries:', error);
        }
    }

    async function loadOrganizations() {
        try {
            const response = await fetch('/api/lint/community-orgs');
            const data = await response.json();
            availableOrganizations = data.community_orgs || [];
            
            // Populate organization dropdown
            organizationFilter.innerHTML = '<option value="">All Orgs</option>';
            availableOrganizations.forEach(org => {
                const option = document.createElement('option');
                option.value = org;
                option.textContent = org;
                organizationFilter.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading organizations:', error);
        }
    }

    async function syncAreas() {
        syncBtn.disabled = true;
        syncBtnText.textContent = 'Syncing...';
        syncSpinner.classList.remove('d-none');

        try {
            const response = await fetch('/api/lint/sync', { method: 'POST' });
            const data = await response.json();

            if (response.ok) {
                showToast('Success', `Synced ${data.processed} areas`, 'success');
                updateUI(data.summary);
                loadTags();  // Reload available tags after sync
                loadCountries();  // Reload countries after sync
                loadOrganizations();  // Reload organizations after sync
                loadResults();
            } else {
                showToast('Error', data.error || 'Sync failed', 'error');
            }
        } catch (error) {
            console.error('Error syncing:', error);
            showToast('Error', 'Failed to sync areas', 'error');
        } finally {
            syncBtn.disabled = false;
            syncBtnText.textContent = 'Sync Areas';
            syncSpinner.classList.add('d-none');
        }
    }

    function updateUI(summary) {
        // Update last sync time
        if (summary.last_sync) {
            const date = new Date(summary.last_sync);
            lastSyncText.textContent = `Last sync: ${date.toLocaleString()}`;
        }

        // Update stats
        document.getElementById('statTotalAreas').textContent = summary.total_areas || 0;
        document.getElementById('statAreasWithIssues').textContent = summary.areas_with_issues || 0;
        document.getElementById('statErrors').textContent = summary.issues_by_severity?.error || 0;
        document.getElementById('statWarnings').textContent = summary.issues_by_severity?.warning || 0;

        // Show/hide sections
        initialState.style.display = 'none';
        summaryStats.style.display = 'flex';
        filtersCard.style.display = 'block';

        if (summary.areas_with_issues > 0) {
            loadResults();
        } else {
            resultsCard.style.display = 'none';
            emptyState.style.display = 'block';
        }
    }

    async function loadResults() {
        const params = getFilterParams();
        const url = `/api/lint/results?issues_only=true&${params}`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            // Update summary stats with filtered data
            if (data.summary) {
                document.getElementById('statTotalAreas').textContent = data.summary.total_areas || 0;
                document.getElementById('statAreasWithIssues').textContent = data.summary.areas_with_issues || 0;
                document.getElementById('statErrors').textContent = data.summary.issues_by_severity?.error || 0;
                document.getElementById('statWarnings').textContent = data.summary.issues_by_severity?.warning || 0;
            }

            if (data.results && data.results.length > 0) {
                allResults = data.results;
                currentPage = 1;
                renderCurrentPage();
                resultsCard.style.display = 'block';
                emptyState.style.display = 'none';
            } else {
                allResults = [];
                resultsCard.style.display = 'none';
                emptyState.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading results:', error);
        }
    }

    function renderCurrentPage() {
        const totalPages = Math.ceil(allResults.length / pageSize);
        const startIdx = (currentPage - 1) * pageSize;
        const endIdx = startIdx + pageSize;
        const pageResults = allResults.slice(startIdx, endIdx);
        
        renderResults(pageResults);
        renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
        pagination.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        if (startPage > 1) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            firstLi.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
            pagination.appendChild(firstLi);
            
            if (startPage > 2) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                pagination.appendChild(ellipsisLi);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                pagination.appendChild(ellipsisLi);
            }
            
            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            lastLi.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
            pagination.appendChild(lastLi);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
        
        // Add click handlers
        pagination.querySelectorAll('a.page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                if (page >= 1 && page <= totalPages && page !== currentPage) {
                    currentPage = page;
                    renderCurrentPage();
                    resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
    }

    function renderResults(results) {
        resultsTableBody.innerHTML = '';

        results.forEach(area => {
            const row = document.createElement('tr');
            
            // Issues badges
            const issuesBadges = area.issues.map(issue => {
                const badgeClass = issue.severity === 'error' ? 'bg-danger' : 
                                   issue.severity === 'warning' ? 'bg-warning text-dark' : 'bg-info';
                let title = issue.message;
                if (issue.clashing_area_names && issue.clashing_area_names.length > 0) {
                    title += '\nAlso used by: ' + issue.clashing_area_names.join(', ');
                }
                return `<span class="badge ${badgeClass} me-1" title="${title}">${issue.rule_name}</span>`;
            }).join('');

            // Action buttons
            const actionButtons = [];
            actionButtons.push(`<a href="/show_area/${area.area_id}" class="btn btn-sm btn-outline-primary">View</a>`);
            
            // Add fix buttons for auto-fixable issues
            const autoFixableIssues = area.issues.filter(i => i.auto_fixable);
            autoFixableIssues.forEach(issue => {
                if (issue.fix_action === 'migrate_icon') {
                    // Link to show_area page with hash to trigger icon modal
                    actionButtons.push(`<a href="/show_area/${area.area_id}#migrate-icon" class="btn btn-sm btn-outline-success">Migrate Icon</a>`);
                } else {
                    const btnText = issue.fix_action === 'bump_verified' ? 'Bump Verified' : 'Fix';
                    actionButtons.push(`<button class="btn btn-sm btn-outline-success fix-btn" data-area-id="${area.area_id}" data-fix-action="${issue.fix_action}">${btnText}</button>`);
                }
            });

            const deletedBadge = area.is_deleted ? '<span class="badge bg-secondary ms-1">Deleted</span>' : '';
            const typeDisplay = area.area_type.charAt(0).toUpperCase() + area.area_type.slice(1);

            row.innerHTML = `
                <td>
                    <strong>${escapeHtml(area.area_name)}</strong>${deletedBadge}
                    <br><small class="text-muted">${area.area_id}</small>
                </td>
                <td>${escapeHtml(typeDisplay)}</td>
                <td>${issuesBadges || '<span class="text-muted">None</span>'}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        ${actionButtons.join('')}
                    </div>
                </td>
            `;

            resultsTableBody.appendChild(row);
        });

        // Attach fix button handlers
        document.querySelectorAll('.fix-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const areaId = this.dataset.areaId;
                const fixAction = this.dataset.fixAction;
                
                this.disabled = true;
                this.textContent = 'Fixing...';

                try {
                    const response = await fetch('/api/lint/fix', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ area_id: areaId, fix_action: fixAction })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showToast('Success', data.message || 'Fixed successfully', 'success');
                        // Reload results to reflect changes
                        loadResults();
                        loadSummary();
                    } else {
                        showToast('Error', data.error || 'Fix failed', 'error');
                        this.disabled = false;
                        this.textContent = 'Retry';
                    }
                } catch (error) {
                    console.error('Error fixing:', error);
                    showToast('Error', 'Failed to apply fix', 'error');
                    this.disabled = false;
                    this.textContent = 'Retry';
                }
            });
        });
    }

});
</script>
{% endblock %}
